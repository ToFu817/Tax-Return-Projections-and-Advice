import React, { useState, useEffect, useMemo } from 'react';
import { Calculator, Building2, DollarSign, PieChart, FileText, AlertCircle, RefreshCw, Layers, Zap, CornerDownRight, ExternalLink } from 'lucide-react';

// ===================================================
// å·¥å…·å‡½æ•¸
// ===================================================

// æ ¼å¼åŒ–é‡‘é¡
const formatCurrency = (val) => {
  if (val === null || val === undefined) return "$0";
  const absoluteVal = Math.abs(val);
  // ä½¿ç”¨ 'zh-TW' æ ¼å¼åŒ–è²¨å¹£
  const formatted = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(absoluteVal);
  return val < 0 ? `-${formatted}` : formatted;
};

// è½‰æ›æ•¸å­—
const parseNumber = (val) => {
  if (!val) return 0;
  // è™•ç†é€—è™Ÿæˆ–éæ•¸å­—å­—ç¬¦ï¼Œç¢ºä¿èƒ½æ­£ç¢ºè§£ææ•¸å­—
  return parseFloat(val.toString().replace(/[^\d\.]/g, ''));
};

// ç‡Ÿæ‰€ç¨…è¨ˆç®—é‚è¼¯ (2024å¹´æ¨™æº–)
const calculateTax = (taxableIncome) => {
    const income = Math.max(0, taxableIncome);
    
    if (income <= 120000) {
      return 0;
    } else if (income <= 200000) {
      // 12è¬åˆ°20è¬çš„éƒ¨åˆ†ï¼Œèª²ç¨…æ‰€å¾—é¡æ¸›åŠèª²å¾µï¼Œå¯¦éš›ç¨…ç‡ç‚º 10%
      return (income - 120000) * 0.5;
    } else {
      // è¶…é20è¬ï¼Œç¨…ç‡ 20%
      return income * 0.2;
    }
};

// ===================================================
// Gemini API å‘¼å«å‡½æ•¸
// ===================================================

const callGeminiAPI = async (systemPrompt, userQuery) => {
  const apiKey = "";
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

  const payload = {
    contents: [{ parts: [{ text: userQuery }] }],
    systemInstruction: {
      parts: [{ text: systemPrompt }]
    },
  };

  let response = null;
  let attempts = 0;
  const maxRetries = 5;

  while (attempts < maxRetries) {
    try {
      response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        const result = await response.json();
        return result.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•ç²å– AI å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      } else if (response.status === 429) {
        // è™•ç†é€Ÿç‡é™åˆ¶èˆ‡æŒ‡æ•¸é€€é¿
        const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
        attempts++;
      } else {
        // éå¯é‡è©¦éŒ¯èª¤
        console.error("API Error:", response.status, response.statusText);
        return `API éŒ¯èª¤ï¼š${response.statusText}`;
      }
    } catch (error) {
      const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
      attempts++;
    }
  }

  return "API å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚";
};


// ===================================================
// React å…ƒä»¶
// ===================================================

const App = () => {
  
  // æ¯”ç‡è¼¸å…¥æ¬„ä½
  const [manualReviewRate, setManualReviewRate] = useState(6.0);      // æ“´å¤§æ›¸å¯©ç´”ç›Šç‡ - for Method 2
  const [manualStandardRate, setManualStandardRate] = useState(24.0);  // æ‰€å¾—é¡æ¨™æº– - for Method 3
  const [manualIndustryRate, setManualIndustryRate] = useState(26.0);  // åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ - for Method 4

  // è²¡å‹™æ•¸æ“šè¼¸å…¥
  const [revenue, setRevenue] = useState('15000000'); // é è¨­å€¼ï¼Œæ–¹ä¾¿æ¸¬è©¦
  const [cost, setCost] = useState('6000000');
  const [expense, setExpense] = useState('7000000');
  
  // LLM ç‹€æ…‹
  const [aiAdvice, setAiAdvice] = useState('');
  const [isAILoading, setIsAILoading] = useState(false);

  // è™•ç†ç™¾åˆ†æ¯”è¼¸å…¥ï¼Œç¢ºä¿æ•¸å€¼åœ¨ 0 åˆ° 100 ä¹‹é–“
  const handleRateChange = (setter) => (e) => {
    let value = parseNumber(e.target.value);
    if (isNaN(value)) value = 0;
    value = Math.max(0, Math.min(100, value)); // é™åˆ¶åœ¨ 0-100
    setter(value);
  };


  // è¨ˆç®—çµæœ (åŒ…å«å››ç¨®æ–¹æ³•)
  const results = useMemo(() => {
    const rev = parseNumber(revenue);
    const cst = parseNumber(cost);
    const exp = parseNumber(expense);

    // 1. æ ¸å¯¦ç”³å ± (å¯¦éš›å¸³å‹™ / æŸ¥å¸³)
    const actualProfit = rev - cst - exp;
    const actualTax = calculateTax(actualProfit);
    const actualNetRate = rev > 0 ? (actualProfit / rev) * 100 : 0;

    // 2. æ“´å¤§æ›¸å¯© (æ›¸å¯©) - ä½¿ç”¨ X%
    const reviewRate = manualReviewRate / 100;
    const reviewProfit = rev * reviewRate;
    const reviewTax = calculateTax(reviewProfit);

    // 3. æ‰€å¾—é¡æ¨™æº– - ä½¿ç”¨ Y%
    const standardRate = manualStandardRate / 100;
    const standardProfit = rev * standardRate;
    const standardTax = calculateTax(standardProfit);
    
    // 4. åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ - ä½¿ç”¨ Y'%
    const industryRate = manualIndustryRate / 100;
    const industryProfit = rev * industryRate;
    // ç¢ºä¿é€™è£¡ç”¨çš„æ˜¯ Profit è€Œé Rate
    const industryTax = calculateTax(industryProfit); 


    return {
      rev, cst, exp,
      actual: { profit: actualProfit, tax: actualTax, rate: actualNetRate, name: 'æ ¸å¯¦ç”³å ± (æŸ¥å¸³)' },
      review: { profit: reviewProfit, tax: reviewTax, name: 'æ“´å¤§æ›¸å¯© (æ›¸å¯©)' },
      standard: { profit: standardProfit, tax: standardTax, name: 'æ‰€å¾—é¡æ¨™æº–' }, // Method 3
      industry: { profit: industryProfit, tax: industryTax, name: 'åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡' } // Method 4
    };
  }, [revenue, cost, expense, manualReviewRate, manualStandardRate, manualIndustryRate]);

  // è™•ç† AI é¡§å•ç”Ÿæˆå»ºè­°
  const handleGenerateAdvice = async () => {
    if (results.rev <= 0) {
      setAiAdvice("è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„å…¨å¹´ç‡Ÿæ¥­æ”¶å…¥æ‰èƒ½é€²è¡Œç¨…å‹™ç­–ç•¥åˆ†æã€‚");
      return;
    }
    
    setIsAILoading(true);
    setAiAdvice('');

    const isOver30M = results.rev > 30000000;
    const taxWarning = isOver30M ? "å…¬å¸ç‡Ÿæ”¶å·²è¶…é 3000 è¬å…ƒé–€æª»ï¼Œé€šå¸¸ä¸é©ç”¨æ“´å¤§æ›¸å¯©ã€‚" : "å…¬å¸ç‡Ÿæ”¶ç¬¦åˆæ“´å¤§æ›¸å¯©é–€æª»ã€‚";

    // è¨ˆç®—æœ€ä½ç¨…é¡å’Œå°æ‡‰çš„æ–¹æ³•
    const methods = [results.actual, results.review, results.standard, results.industry];
    const minTax = Math.min(...methods.map(m => m.tax));
    const bestMethods = methods.filter(m => m.tax === minTax).map(m => m.name);

    // æ ¼å¼åŒ–æ•¸æ“šä»¥ä¾› LLM é–±è®€ (åŒ…å«æ‰€æœ‰å››ç¨®æ–¹æ³•)
    const dataForLLM = `
      --- è²¡å‹™æ•¸æ“š ---
      å…¨å¹´ç‡Ÿæ¥­æ”¶å…¥ (A): ${formatCurrency(results.rev)}
      ç‡Ÿæ¥­æˆæœ¬ (B): ${formatCurrency(results.cst)}
      ç‡Ÿæ¥­è²»ç”¨ (C): ${formatCurrency(results.exp)}
      å¯¦éš›æ·¨åˆ© (A-B-C): ${formatCurrency(results.actual.profit)}
      å¯¦éš›æ·¨åˆ©ç‡: ${results.actual.rate.toFixed(2)}%

      --- è¡Œæ¥­æ¨™æº– (æ‰‹å‹•è¼¸å…¥) ---
      æ“´å¤§æ›¸å¯©ç´”ç›Šç‡: ${manualReviewRate.toFixed(2)}%
      æ‰€å¾—é¡æ¨™æº–: ${manualStandardRate.toFixed(2)}%
      åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ï¼š${manualIndustryRate.toFixed(2)}%
      ${taxWarning}

      --- è©¦ç®—çµæœæ¯”è¼ƒ (å››ç¨®æ–¹æ³•) ---
      1. æ ¸å¯¦ç”³å ± (æŸ¥å¸³):
         èª²ç¨…æ‰€å¾—é¡: ${formatCurrency(results.actual.profit)}
         æ‡‰ç´ç¨…é¡: ${formatCurrency(results.actual.tax)}
      
      2. æ“´å¤§æ›¸å¯© (æ›¸å¯©):
         èª²ç¨…æ‰€å¾—é¡: ${formatCurrency(results.review.profit)}
         æ‡‰ç´ç¨…é¡: ${formatCurrency(results.review.tax)}

      3. æ‰€å¾—é¡æ¨™æº–:
         èª²ç¨…æ‰€å¾—é¡: ${formatCurrency(results.standard.profit)}
         æ‡‰ç´ç¨…é¡: ${formatCurrency(results.standard.tax)}

      4. åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡:
         èª²ç¨…æ‰€å¾—é¡: ${formatCurrency(results.industry.profit)}
         æ‡‰ç´ç¨…é¡: ${formatCurrency(results.industry.tax)}

      --- è©¦ç®—ç¸½çµ ---
      è©¦ç®—ä¸­æœ€ä½æ‡‰ç´ç¨…é¡ç‚º: ${formatCurrency(minTax)}
      é”æˆæœ€ä½ç¨…é¡çš„ç”³å ±æ–¹æ³•æ˜¯: ${bestMethods.join(' æˆ– ')}
    `;

    // System Prompt å°ˆç‚ºç°¡æ½”å»ºè­°è¨­è¨ˆ (æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ - å·²åŠ å…¥æ›´åš´æ ¼çš„æŸ¥å¸³é¢¨éšªè©•ä¼°)
    const systemPrompt = `æ‚¨æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£æœƒè¨ˆå¸«åŠç¨…å‹™åˆ†æå¸«ã€‚æ‚¨çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„è²¡å‹™æ•¸æ“šå’Œå››ç¨®ç”³å ±è©¦ç®—çµæœï¼Œç‚ºä¼æ¥­ä¸»æä¾›**å–®ä¸€ã€ç°¡æ½”ã€ç›´æ¥**çš„ç”³å ±ç­–ç•¥å»ºè­°ã€‚

**æ ¸å¿ƒé‚è¼¯ (å¿…é ˆéµå®ˆ):**
1. **ç›®æ¨™**ï¼šåœ¨åˆæ³•æ¡†æ¶å…§ï¼Œå»ºè­°èƒ½é”æˆæœ€ä½ç¨…è² ä¸”**æŸ¥å¸³é¢¨éšªæœ€ä½**çš„ç”³å ±æ–¹æ³•ã€‚
2. **æ“´å¤§æ›¸å¯© (æ›¸å¯©) é¢¨éšª**ï¼šå¦‚æœã€Œæ ¸å¯¦ç”³å ± (æŸ¥å¸³)ã€çš„**å¯¦éš›æ·¨åˆ©ç‡**é¡¯è‘—é«˜æ–¼ã€Œæ“´å¤§æ›¸å¯© (æ›¸å¯©)ã€çš„**ç´”ç›Šç‡**ï¼ˆä¾‹å¦‚ï¼Œé«˜å‡ºè¶…é 2%ï¼‰ï¼Œä¸”å…¬å¸ç‡Ÿæ”¶ä½æ–¼ 3000 è¬å…ƒï¼ˆé©ç”¨æ›¸å¯©é–€æª»ï¼‰ï¼Œå‰‡**çµ•å°ä¸å»ºè­°**ç”³å ±ã€Œæ“´å¤§æ›¸å¯©ã€ï¼Œå³ä½¿å…¶ç¨…é¡æœ€ä½ã€‚
3. **æŸ¥å¸³é¢¨éšª (æˆæœ¬ä¸è¶³)**ï¼šç•¶**å¯¦éš›æ·¨åˆ©ç‡**é«˜æ–¼**æ‰€å¾—é¡æ¨™æº–**æ™‚ï¼Œä»£è¡¨å¸³ä¸Šæˆæœ¬è²»ç”¨ä¸è¶³ï¼Œç”³å ±ã€Œæ ¸å¯¦ç”³å ± (æŸ¥å¸³)ã€å¯èƒ½è¢«åœ‹ç¨…å±€ç›´æ¥èª¿æ•´åˆ°ã€Œæ‰€å¾—é¡æ¨™æº–ã€æˆ–æ›´é«˜çš„ã€ŒåŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ã€èª²ç¨…ã€‚
4. **é¢¨éšªå°å‘æ¨è–¦**ï¼š
    a. å¦‚æœæ“´å¤§æ›¸å¯©æœ‰é«˜é¢¨éšªï¼ˆä¾æ“šç¬¬2é»ï¼‰ï¼Œæˆ–ç”³å ±æ ¸å¯¦æŸ¥å¸³æœ‰é«˜é¢¨éšªï¼ˆä¾æ“šç¬¬3é»ï¼‰ï¼Œå‰‡æ‡‰**è½‰è€Œå»ºè­°**æ¡ç”¨**æ‰€å¾—é¡æ¨™æº–**ä½œç‚ºæœ€å®‰å…¨çš„ç”³å ±é¸é …ï¼Œä¸¦ç°¡è¦èªªæ˜é€™æ˜¯ç‚ºäº†**é¿å…åœ‹ç¨…å±€èª¿å¸³é¢¨éšª**ã€‚
    b. è‹¥ç„¡ä¸Šè¿°é«˜é¢¨éšªï¼Œå‰‡å„ªå…ˆæ¨è–¦è©¦ç®—ä¸­ç¨…é¡æœ€ä½çš„é¸é …ã€‚

**è¼¸å‡ºæ ¼å¼**ï¼šæ‚¨çš„å›æ‡‰å¿…é ˆæ˜¯**ä¸€å€‹çµæ§‹åŒ–çš„å–®ä¸€æ®µè½**ï¼Œç›´æ¥å»ºè­°æœ€ä½³ç”³å ±æ–¹å¼å’Œç†ç”±ï¼Œä¸è¦ä½¿ç”¨ä»»ä½•æ¨™é¡Œæˆ–é»åˆ—æ¸…å–®ã€‚

**å‹™å¿…åœ¨å»ºè­°çµå°¾æ˜ç¢ºæŒ‡å‡ºï¼šæœ¬åˆ†æç‚ºé›»è…¦æ¨¡æ“¬ï¼Œæœ€çµ‚ç”³å ±è«‹å‹™å¿…è«®è©¢å°ˆæ¥­æœƒè¨ˆå¸«ï¼Œä»¥é¿å…ç¨…å‹™é¢¨éšªã€‚**è«‹å‹¿ä½¿ç”¨ä»»ä½•ç¨‹å¼ç¢¼å€å¡Šã€‚`;

    const advice = await callGeminiAPI(systemPrompt, `è«‹æ ¹æ“šä»¥ä¸‹æ•¸æ“šç”Ÿæˆç¨…å‹™ç”³å ±ç­–ç•¥å»ºè­°æ›¸:\n${dataForLLM}`);
    
    setAiAdvice(advice);
    setIsAILoading(false);
  };

  // åœ¨æ•¸æ“šæˆ–æ¯”ç‡è®Šå‹•æ™‚æ¸…é™¤èˆŠçš„å»ºè­°
  useEffect(() => {
    setAiAdvice('');
  }, [revenue, cost, expense, manualReviewRate, manualStandardRate, manualIndustryRate]);

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        
        {/* Header */}
        <header className="mb-8 text-center md:text-left flex flex-col md:flex-row justify-between items-center">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3 justify-center md:justify-start">
              <Calculator className="w-8 h-8 text-blue-600" />
              ç‡Ÿåˆ©äº‹æ¥­æ‰€å¾—ç¨…å››ç¨®ç”³å ±æ–¹æ³•è©¦ç®—æ©Ÿ
            </h1>
            <p className="text-slate-500 mt-2">
              æ¯”è¼ƒã€ŒæŸ¥å¸³ã€ã€ã€Œæ›¸å¯©ã€ã€ã€Œæ‰€å¾—é¡æ¨™æº–ã€èˆ‡ã€ŒåŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ã€ä¸‹çš„èª²ç¨…æ‰€å¾—åŠç¨…è² å·®ç•°
            </p>
          </div>
          <div className="mt-4 md:mt-0 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-sm font-medium">
            ç‡Ÿæ‰€ç¨…ç‡: 20%
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Left Column: Inputs */}
          <div className="lg:col-span-1 space-y-6">
            
            {/* Section 1: Standard Rate Inputs (Three fields) */}
            <div className="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
              <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Building2 className="w-5 h-5 text-slate-400" />
                æ¨™æº–æ¯”ç‡è¼¸å…¥æŒ‡å—
              </h2>
              
              <div className="space-y-4">
                
                {/* æ­¥é©ŸæŒ‡å— - æ ¹æ“šä½¿ç”¨è€…è¦æ±‚æ›´æ–° */}
                <div className="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-md">
                    <p className="text-sm font-semibold text-blue-800 mb-2">ğŸ“ ç”³å ±ç­–ç•¥è©¦ç®—æ­¥é©Ÿ</p>
                    <ol className="list-decimal list-inside text-xs text-blue-700 space-y-2 pl-1">
                        <li>
                            æŸ¥è©¢å…¬å¸**è¡Œæ¥­ä»£ç¢¼**ï¼šè«‹è‡³ 
                            <a 
                                href="https://www.etax.nat.gov.tw/etwmain/etw113w1/ban/query" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="text-blue-600 hover:text-blue-800 underline flex items-center gap-1 ml-1 inline-flex"
                            >
                                åœ‹ç¨…å±€ç‡Ÿæ¥­äººä»£ç¢¼æŸ¥è©¢ <ExternalLink className="w-3 h-3" />
                            </a>
                        </li>
                        <li>
                            æŸ¥è©¢**æ¨™æº–æ¯”ç‡**ï¼šå‰å¾€ 
                            <a 
                                href="https://service.mof.gov.tw/public/Data/statistic/std/zhtw/search.html" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="text-blue-600 hover:text-blue-800 underline flex items-center gap-1 ml-1 inline-flex"
                            >
                                ç¨…å‹™è¡Œæ¥­æ¨™æº–åˆ†é¡æš¨åŒæ¥­åˆ©æ½¤æ¨™æº–æŸ¥è©¢ç³»çµ± <ExternalLink className="w-3 h-3" />
                            </a>
                        </li>
                        <li>è¼¸å…¥**æ“´å¤§æ›¸å¯©ç´”ç›Šç‡**ã€**æ‰€å¾—é¡æ¨™æº–**ã€**åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡** æ–¼ä¸‹æ–¹æ¬„ä½ã€‚</li>
                        <li>è¼¸å…¥ç›®å‰å¯¦éš›**ç‡Ÿæ¥­æ”¶å…¥ã€æˆæœ¬èˆ‡è²»ç”¨**ã€‚</li>
                        <li>é»æ“Š **AI é¡§å•æŒ‰éˆ•**ï¼Œå–å¾—ç”³å ±å»ºè­°ã€‚</li>
                    </ol>
                </div>
                
                {/* æ“´å¤§æ›¸å¯©ç´”ç›Šç‡è¼¸å…¥ */}
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">æ“´å¤§æ›¸å¯©ç´”ç›Šç‡ <span className="text-blue-500 font-bold">(ç”¨æ–¼æ–¹æ³•äºŒ)</span></label>
                  <div className="relative">
                    <input 
                      type="number" 
                      step="0.1"
                      min="0"
                      max="100"
                      value={manualReviewRate}
                      onChange={handleRateChange(setManualReviewRate)}
                      placeholder="ä¾‹å¦‚: 6.0"
                      className="w-full pr-8 pl-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg"
                    />
                    <span className="absolute right-3 top-2.5 text-slate-400 font-bold">%</span>
                  </div>
                </div>

                {/* æ‰€å¾—é¡æ¨™æº–è¼¸å…¥ (ç”¨æ–¼è¨ˆç®— Method 3) */}
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">æ‰€å¾—é¡æ¨™æº– <span className="text-orange-500 font-bold">(ç”¨æ–¼æ–¹æ³•ä¸‰)</span></label>
                  <div className="relative">
                    <input 
                      type="number" 
                      step="0.1"
                      min="0"
                      max="100"
                      value={manualStandardRate}
                      onChange={handleRateChange(setManualStandardRate)}
                      placeholder="ä¾‹å¦‚: 24.0"
                      className="w-full pr-8 pl-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none font-mono text-lg"
                    />
                    <span className="absolute right-3 top-2.5 text-slate-400 font-bold">%</span>
                  </div>
                </div>

                {/* åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡è¼¸å…¥ (ç”¨æ–¼è¨ˆç®— Method 4) */}
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ <span className="text-purple-500 font-bold">(ç”¨æ–¼æ–¹æ³•å››)</span></label>
                  <div className="relative">
                    <input 
                      type="number" 
                      step="0.1"
                      min="0"
                      max="100"
                      value={manualIndustryRate}
                      onChange={handleRateChange(setManualIndustryRate)}
                      placeholder="ä¾‹å¦‚: 26.0"
                      className="w-full pr-8 pl-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none font-mono text-lg"
                    />
                    <span className="absolute right-3 top-2.5 text-slate-400 font-bold">%</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Section 2: Financials */}
            <div className="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
              <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <DollarSign className="w-5 h-5 text-slate-400" />
                è²¡å‹™æ•¸æ“šè¼¸å…¥
              </h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">å…¨å¹´ç‡Ÿæ¥­æ”¶å…¥ (ä¸å«ç¨…)</label>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-400">TWD</span>
                    <input 
                      type="number" 
                      value={revenue}
                      onChange={(e) => setRevenue(e.target.value)}
                      placeholder="0"
                      className="w-full pl-12 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none font-mono text-lg"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">ç‡Ÿæ¥­æˆæœ¬</label>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-400">TWD</span>
                    <input 
                      type="number" 
                      value={cost}
                      onChange={(e) => setCost(e.target.value)}
                      placeholder="0"
                      className="w-full pl-12 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none font-mono text-lg"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">ç‡Ÿæ¥­è²»ç”¨</label>
                  <div className="relative">
                    <span className="absolute left-3 top-2.5 text-slate-400">TWD</span>
                    <input 
                      type="number" 
                      value={expense}
                      onChange={(e) => setExpense(e.target.value)}
                      placeholder="0"
                      className="w-full pl-12 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none font-mono text-lg"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Right Column: Results - Grid of 4 Methods & AI Advisor (Colspan 2) */}
          <div className="lg:col-span-2 space-y-6">
             <h2 className="text-xl font-bold text-slate-700 mb-4">ç¨…å‹™ç”³å ±æ–¹å¼æ¯”è¼ƒ (å››ç¨®æ–¹æ³•)</h2>
             
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                
                {/* Method 1: Actual Reporting (æ ¸å¯¦ç”³å ±/æŸ¥å¸³) */}
                <ResultCard 
                title="æ–¹æ³•ä¸€ï¼šæŸ¥å¸³ (æ ¸å¯¦ç”³å ±)"
                icon={FileText}
                color="green"
                description="å¯¦éš›æ”¶å…¥ - å¯¦éš›æˆæœ¬è²»ç”¨ = èª²ç¨…æ‰€å¾—ã€‚æœ€æ¨™æº–çš„ç”³å ±æ–¹å¼ã€‚"
                profit={results.actual.profit}
                tax={results.actual.tax}
                details={
                    <>
                    <div className="flex justify-between border-b border-slate-100 pb-2">
                        <span className="text-slate-500">å¯¦éš›æ·¨åˆ©ç‡</span>
                        <span className="font-mono text-sm">{results.actual.rate.toFixed(2)}%</span>
                    </div>
                    </>
                }
                />

                {/* Method 2: Expanded Paper Review (æ“´å¤§æ›¸å¯©/æ›¸å¯©) */}
                <ResultCard 
                title="æ–¹æ³•äºŒï¼šæ›¸å¯© (æ“´å¤§æ›¸å¯©)"
                icon={PieChart}
                color="blue"
                description={`ç‡Ÿæ”¶ Ã— ${manualReviewRate}% = æ¨è¨ˆæ‰€å¾—ã€‚é©ç”¨ç‡Ÿæ”¶ä½æ–¼é–€æª»ä¹‹å…¬å¸ã€‚`}
                profit={results.review.profit}
                tax={results.review.tax}
                details={
                    <>
                    <div className="flex justify-between border-b border-slate-100 pb-2">
                        <span className="text-slate-500">æ›¸å¯©ç´”ç›Šç‡</span>
                        <span className="font-mono text-blue-600 font-bold text-sm">{manualReviewRate.toFixed(2)}%</span>
                    </div>
                    </>
                }
                />

                {/* Method 3: Standard Profit Rate (æ‰€å¾—é¡æ¨™æº–) */}
                <ResultCard 
                title="æ–¹æ³•ä¸‰ï¼šæ‰€å¾—é¡æ¨™æº–"
                icon={Layers}
                color="orange"
                description={`ç‡Ÿæ”¶ Ã— ${manualStandardRate}% = æ¨è¨ˆæ‰€å¾—ã€‚é€šå¸¸ç”¨æ–¼å¸³è­‰ä¸é½Šå…¨æ™‚ã€‚`}
                profit={results.standard.profit}
                tax={results.standard.tax}
                details={
                    <>
                    <div className="flex justify-between border-b border-slate-100 pb-2">
                        <span className="text-slate-500">æ‰€å¾—é¡æ¨™æº–</span>
                        <span className="font-mono text-orange-600 font-bold text-sm">{manualStandardRate.toFixed(2)}%</span>
                    </div>
                    </>
                }
                />

                {/* Method 4: Industry Profit Standard (åŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡) */}
                <ResultCard 
                title="æ–¹æ³•å››ï¼šåŒæ¥­æ·¨åˆ©ç‡"
                icon={Layers}
                color="purple"
                description={`ç‡Ÿæ”¶ Ã— ${manualIndustryRate}% = æ¨è¨ˆæ‰€å¾—ã€‚ç”¨æ–¼è¨ˆç®—åˆ©æ½¤ç‡ä¸Šé™ã€‚`}
                profit={results.industry.profit}
                tax={results.industry.tax}
                details={
                    <>
                    <div className="flex justify-between border-b border-slate-100 pb-2">
                        <span className="text-slate-500">åŒæ¥­æ·¨åˆ©ç‡æ¨™æº–</span>
                        <span className="font-mono text-purple-600 font-bold text-sm">{manualIndustryRate.toFixed(2)}%</span>
                    </div>
                    </>
                }
                />

            </div>
            
            {/* AI Tax Advisor Section */}
            <div className="bg-white p-6 rounded-xl shadow-lg border border-purple-200">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-purple-700 flex items-center gap-2">
                        <Zap className="w-6 h-6 text-purple-500" />
                        æ™ºæ…§ç¨…å‹™é¡§å• âœ¨
                    </h2>
                    <button 
                        onClick={handleGenerateAdvice}
                        disabled={isAILoading || results.rev <= 0}
                        className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50 transition shadow-md"
                    >
                        {isAILoading ? <RefreshCw className="w-4 h-4 animate-spin" /> : <CornerDownRight className="w-4 h-4" />}
                        {isAILoading ? 'åˆ†æä¸­...' : 'ç”Ÿæˆç”³å ±ç­–ç•¥å»ºè­°'}
                    </button>
                </div>
                
                <div className="min-h-32 bg-purple-50 p-4 rounded-lg text-sm text-slate-700 border border-purple-100">
                    {aiAdvice ? (
                        // ä½¿ç”¨ dangerouslySetInnerHTML æ¸²æŸ“ LLM è¼¸å‡ºçš„ Markdown æ ¼å¼åŒ–å…§å®¹
                        // Note: LLM output is now a concise paragraph.
                        <div className="whitespace-pre-wrap" dangerouslySetInnerHTML={{ __html: aiAdvice }} />
                    ) : (
                        <p className="text-slate-500 italic">é»æ“Šä¸Šæ–¹çš„æŒ‰éˆ•ï¼Œè®“ AI æ ¹æ“šæ‚¨çš„è²¡å‹™æ•¸æ“šå’Œå››ç¨®æ¯”ç‡ï¼Œç”Ÿæˆä¸€ä»½å®¢è£½åŒ–çš„ç¨…å‹™ç”³å ±ç­–ç•¥åˆ†æå ±å‘Šã€‚</p>
                    )}
                </div>
            </div>


            {/* Comparison Logic / Warning */}
            {parseNumber(revenue) > 30000000 && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-red-800">
                  <p className="font-bold">é‡è¦æé†’ï¼šç‡Ÿæ”¶è¶…é 3,000 è¬å…ƒé™åˆ¶</p>
                  <p>é€šå¸¸ä¸é©ç”¨ã€Œæ“´å¤§æ›¸å¯©ã€ç”³å ±ï¼Œå¿…é ˆæ¡ç”¨ã€Œæ ¸å¯¦ç”³å ±ã€(æŸ¥å¸³) æˆ–æœƒè¨ˆå¸«ç°½è­‰ç”³å ±ã€‚å¦‚æœå¸³è­‰ä¸å®Œå‚™ï¼Œå°‡ç›´æ¥ä¾ã€Œæ‰€å¾—é¡æ¨™æº–ã€æˆ–ã€ŒåŒæ¥­åˆ©æ½¤æ¨™æº–æ·¨åˆ©ç‡ã€æ ¸å®šï¼Œå»ºè­°å‹™å¿…æ ¸å¯¦ç”³å ±ã€‚</p>
                </div>
              </div>
            )}
            
            <div className="bg-slate-100 p-4 rounded-lg text-xs text-slate-500">
              <p className="font-bold mb-1">å…è²¬è²æ˜ï¼š</p>
              <p>1. æœ¬å·¥å…·åƒ…ä¾›è²¡å‹™è©¦ç®—åƒè€ƒï¼Œ**æ‰€æœ‰ç™¾åˆ†æ¯”çš†ç”±ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥**ï¼Œå¯¦éš›ç¨…é¡ä»¥åœ‹ç¨…å±€æ ¸å®šç‚ºæº–ã€‚è«‹è«®è©¢å°ˆæ¥­æœƒè¨ˆå¸«æˆ–ç¨…å‹™é¡§å•ã€‚</p>
              <p>2. è¡Œæ¥­ä»£ç¢¼èˆ‡åˆ©æ½¤æ¨™æº–æœƒéš¨å¹´åº¦è®Šå‹•ï¼Œè«‹ä»¥è²¡æ”¿éƒ¨æœ€æ–°å…¬å‘Šç‚ºæº–ã€‚</p>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
};

// ç¨ç«‹çš„çµæœå¡ç‰‡å…ƒä»¶ï¼Œç”¨æ–¼é‡è¦†ä½¿ç”¨
const ResultCard = ({ title, icon: Icon, color, description, profit, tax, details }) => {
  // æ“´å……é¡è‰²è¨­å®šï¼Œæ–°å¢ purple
  const colorClasses = {
    green: { bg: 'bg-green-600', text: 'text-green-700', lightBg: 'bg-green-50', lightBorder: 'border-green-100', textLight: 'text-green-600' },
    blue: { bg: 'bg-blue-600', text: 'text-blue-700', lightBg: 'bg-blue-50', lightBorder: 'border-blue-100', textLight: 'text-blue-600' },
    orange: { bg: 'bg-orange-600', text: 'text-orange-700', lightBg: 'bg-orange-50', lightBorder: 'border-orange-100', textLight: 'text-orange-600' },
    purple: { bg: 'bg-purple-600', text: 'text-purple-700', lightBg: 'bg-purple-50', lightBorder: 'border-purple-100', textLight: 'text-purple-600' },
  }[color];

  const taxBreakdown = useMemo(() => {
    if (profit <= 120000) return 'æ·¨åˆ© 12 è¬ä»¥ä¸‹å…å¾µ';
    if (profit <= 200000) return 'è¶…é 12 è¬éƒ¨åˆ†æ¸›åŠèª²å¾µ';
    return 'ç¨…ç‡ 20%';
  }, [profit]);

  return (
    <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden transition-all hover:shadow-xl h-full flex flex-col">
      <div className={`${colorClasses.bg} text-white px-3 py-2 flex justify-between items-center flex-shrink-0`}>
        <h3 className="font-bold text-sm md:text-base flex items-center gap-2">
          <Icon className="w-4 h-4" /> 
          {title}
        </h3>
      </div>
      <div className="p-3 flex-grow flex flex-col justify-between">
        <div>
            <p className="text-[10px] md:text-xs text-slate-500 mb-3 p-1 rounded bg-slate-50 border border-slate-100">
                {description}
            </p>
            <div className="space-y-2 text-[10px] md:text-xs">
                {details}
            </div>
            
            <div className="flex flex-col md:flex-row justify-between items-center pt-2 mt-2 border-t border-dashed border-slate-300">
                <span className="font-bold text-slate-800 text-sm">èª²ç¨…æ‰€å¾—é¡</span>
                <span className={`font-mono font-extrabold text-lg md:text-xl ${colorClasses.textLight}`}>
                    {formatCurrency(profit)}
                </span>
            </div>
        </div>

        <div className={`mt-3 ${colorClasses.lightBg} rounded-lg p-2 flex flex-col justify-center items-center border ${colorClasses.lightBorder} flex-shrink-0`}>
            <span className="text-slate-500 text-[10px] md:text-xs mb-1">é ä¼°æ‡‰ç´ç‡Ÿæ‰€ç¨…é¡</span>
            <span className={`text-xl md:text-2xl font-black ${colorClasses.text} font-mono`}>
              {formatCurrency(tax)}
            </span>
            <div className="mt-1 text-[10px] text-center text-slate-500">
              <p>{taxBreakdown}</p>
            </div>
        </div>
      </div>
    </div>
  );
};

export default App;
